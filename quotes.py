"""
–ú–æ–¥—É–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–∏—Ç–∞—Ç–∞–º–∏.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ database.py (–≤–∞—Ä–∏–∞–Ω—Ç 2).
"""
from database import get_random_quote, get_all_tags, add_quote


def format_quote_for_display(quote_text: str) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Telegram.
    
    Args:
        quote_text (str): –¢–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        
    Returns:
        str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
        
    –ü—Ä–∏–º–µ—Ä:
        >>> format_quote_for_display("–¢–µ–∫—Å—Ç\\n\\n‚Äî –ê–≤—Ç–æ—Ä")
        "–¢–µ–∫—Å—Ç\\n\\n‚Äî –ê–≤—Ç–æ—Ä"
    """
    # –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —É–∂–µ –µ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    if "‚Äî" in quote_text:
        return quote_text
    
    # –ò–Ω–∞—á–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
    return f"üí¨ {quote_text}"


def get_quote_by_tag(tag_name: str = None) -> str:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Ü–∏—Ç–∞—Ç—É –ø–æ —Ç–µ–≥—É –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –µ—ë –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.
    
    Args:
        tag_name (str, optional): –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏. –ï—Å–ª–∏ None, –≤–µ—Ä–Ω—ë—Ç –ª—é–±—É—é —Ü–∏—Ç–∞—Ç—É.
        
    Returns:
        str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        
    –ü—Ä–∏–º–µ—Ä—ã:
        >>> get_quote_by_tag("–ú–æ—Ç–∏–≤–∞—Ü–∏—è")
        "üí¨ –¢–µ–∫—Å—Ç –º–æ—Ç–∏–≤–∏—Ä—É—é—â–µ–π —Ü–∏—Ç–∞—Ç—ã\\n\\n‚Äî –ê–≤—Ç–æ—Ä"
        
        >>> get_quote_by_tag()
        "üí¨ –õ—é–±–∞—è —Å–ª—É—á–∞–π–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞\\n\\n‚Äî –ê–≤—Ç–æ—Ä"
    """
    try:
        quote = get_random_quote(tag_name)
        if quote == "–¶–∏—Ç–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã":
            if tag_name:
                return f"üòî –¶–∏—Ç–∞—Ç —Å —Ç–µ–≥–æ–º '#{tag_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ç–µ–≥ –∏–ª–∏ /tags –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ç–µ–≥–æ–≤."
            else:
                return "üòî –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç —Ü–∏—Ç–∞—Ç.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /add, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é —Ü–∏—Ç–∞—Ç—É!"
        
        return format_quote_for_display(quote)
    except Exception as e:
        return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ü–∏—Ç–∞—Ç—ã: {str(e)}"


def get_formatted_tags_list() -> str:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —Ç–µ–≥–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏—Ö –≤ –∫—Ä–∞—Å–∏–≤—ã–π —Å–ø–∏—Å–æ–∫.
    
    Returns:
        str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–µ–≥–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        
    –ü—Ä–∏–º–µ—Ä:
        >>> get_formatted_tags_list()
        "üìö –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–≥–∏:\\n\\n‚Ä¢ #–ú–æ—Ç–∏–≤–∞—Ü–∏—è\\n‚Ä¢ #–Æ–º–æ—Ä\\n‚Ä¢ #–õ—é–±–æ–≤—å\\n\\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /quote [—Ç–µ–≥]"
    """
    try:
        tags = get_all_tags()
        
        if not tags:
            return "üì≠ –¢–µ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ü–∏—Ç–∞—Ç—É —Å —Ç–µ–≥–æ–º –∫–æ–º–∞–Ω–¥–æ–π /add!"
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–≥–∏ –∫–∞–∫ —Ö–µ—à—Ç–µ–≥–∏
        tags_formatted = "\n".join([f"‚Ä¢ #{tag}" for tag in tags])
        
        return (f"üìö *–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–≥–∏:*\n\n"
                f"{tags_formatted}\n\n"
                f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É:\n`/quote [—Ç–µ–≥]`\n\n"
                f"*–ü—Ä–∏–º–µ—Ä:* `/quote {tags[0]}`")
    except Exception as e:
        return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–µ–≥–æ–≤: {str(e)}"


def add_new_quote_with_validation(text: str, author: str, tags_input: str) -> str:
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é —Ü–∏—Ç–∞—Ç—É —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    
    Args:
        text (str): –¢–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã
        author (str): –ê–≤—Ç–æ—Ä —Ü–∏—Ç–∞—Ç—ã
        tags_input (str): –¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
        
    Returns:
        str: –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        
    –ü—Ä–∏–º–µ—Ä:
        >>> add_new_quote_with_validation("–ñ–∏–∑–Ω—å –ø—Ä–µ–∫—Ä–∞—Å–Ω–∞", "–û–ø—Ç–∏–º–∏—Å—Ç", "–º–æ—Ç–∏–≤–∞—Ü–∏—è, —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è")
        "‚úÖ –¶–∏—Ç–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!"
    """
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –ø–æ–ª—è
    if not text or not text.strip():
        return "‚ùå –¢–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!"
    
    if not author or not author.strip():
        return "‚ùå –ê–≤—Ç–æ—Ä –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!"
    
    if not tags_input or not tags_input.strip():
        return "‚ùå –£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ–≥!"
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–≥–∏
    tags_list = []
    for tag in tags_input.split(','):
        tag_clean = tag.strip()
        if tag_clean:  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Ç–µ–≥–∏
            tags_list.append(tag_clean)
    
    if not tags_list:
        return "‚ùå –£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ–≥!"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É —Ç–µ–≥–æ–≤
    for tag in tags_list:
        if len(tag) > 50:
            return f"‚ùå –¢–µ–≥ '{tag}' —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–º–∞–∫—Å–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤)"
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ü–∏—Ç–∞—Ç—É
    try:
        success = add_quote(text.strip(), author.strip(), tags_list)
        if success:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–≥–∏ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            tags_formatted = ", ".join([f"#{tag}" for tag in tags_list])
            return (f"‚úÖ *–¶–∏—Ç–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!*\n\n"
                    f"üí¨ *–¶–∏—Ç–∞—Ç–∞:* {text.strip()}\n"
                    f"üë§ *–ê–≤—Ç–æ—Ä:* {author.strip()}\n"
                    f"üè∑ *–¢–µ–≥–∏:* {tags_formatted}")
        else:
            return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ü–∏—Ç–∞—Ç—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    except Exception as e:
        error_msg = str(e)
        if "UNIQUE constraint failed" in error_msg:
            return "‚ùå –¢–∞–∫–∞—è —Ü–∏—Ç–∞—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
        else:
            return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ü–∏—Ç–∞—Ç—ã: {error_msg}"


def search_quotes_count_by_tag(tag_name: str) -> str:
    """
    –ò—â–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏—Ç–∞—Ç –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É —Ç–µ–≥—É.
    
    Args:
        tag_name (str): –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
        
    Returns:
        str: –°–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ü–∏—Ç–∞—Ç
        
    –ü—Ä–∏–º–µ—Ä:
        >>> search_quotes_count_by_tag("–ú–æ—Ç–∏–≤–∞—Ü–∏—è")
        "üîç –ù–∞–π–¥–µ–Ω–æ 5 —Ü–∏—Ç–∞—Ç —Å —Ç–µ–≥–æ–º #–ú–æ—Ç–∏–≤–∞—Ü–∏—è"
    """
    try:
        # –í –Ω–∞—à–µ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ 2 database.py –Ω–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        # –ü–æ—ç—Ç–æ–º—É –ø–æ–ª—É—á–∏–º –≤—Å–µ —Ü–∏—Ç–∞—Ç—ã —Å —ç—Ç–∏–º —Ç–µ–≥–æ–º —á–µ—Ä–µ–∑ get_random_quote
        # (–≠—Ç–æ –Ω–µ —Å–∞–º–æ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ, –Ω–æ –ø—Ä–æ—Å—Ç–æ–µ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è)
        # –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –ª—É—á—à–µ –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤ database.py
        
        from database import cursor, conn
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞
        cursor.execute('''
            SELECT COUNT(*) 
            FROM quotes q
            JOIN quote_tags qt ON q.id = qt.quote_id
            JOIN tags t ON qt.tag_id = t.id
            WHERE t.name = ?
        ''', (tag_name,))
        
        count = cursor.fetchone()[0]
        
        if count == 0:
            return f"üîç –¶–∏—Ç–∞—Ç —Å —Ç–µ–≥–æ–º '#{tag_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
        elif count == 1:
            return f"üîç –ù–∞–π–¥–µ–Ω–∞ 1 —Ü–∏—Ç–∞—Ç–∞ —Å —Ç–µ–≥–æ–º #{tag_name}."
        else:
            return f"üîç –ù–∞–π–¥–µ–Ω–æ {count} —Ü–∏—Ç–∞—Ç —Å —Ç–µ–≥–æ–º #{tag_name}."
            
    except Exception as e:
        return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: {str(e)}"


# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
if __name__ == "__main__":
    print("=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è quotes.py ===\n")
    
    # –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–π —Ü–∏—Ç–∞—Ç—ã
    print("1. –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–π —Ü–∏—Ç–∞—Ç—ã:")
    random_quote = get_quote_by_tag()
    print(random_quote[:100] + "..." if len(random_quote) > 100 else random_quote)
    print()
    
    # –¢–µ—Å—Ç 2: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–µ–≥–æ–≤
    print("2. –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–≥–æ–≤:")
    tags = get_formatted_tags_list()
    print(tags[:150] + "..." if len(tags) > 150 else tags)
    print()
    
    # –¢–µ—Å—Ç 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ü–∏—Ç–∞—Ç—ã
    print("3. –¢–µ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ü–∏—Ç–∞—Ç—ã:")
    result = add_new_quote_with_validation(
        "–¢–µ—Å—Ç–æ–≤–∞—è —Ü–∏—Ç–∞—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏",
        "–¢–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ—Ä",
        "—Ç–µ—Å—Ç, –ø—Ä–æ–≤–µ—Ä–∫–∞"
    )
    print(result)
    print()
    
    # –¢–µ—Å—Ç 4: –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–≥—É
    print("4. –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–µ–≥—É:")
    search_result = search_quotes_count_by_tag("–ú–æ—Ç–∏–≤–∞—Ü–∏—è")
    print(search_result)
